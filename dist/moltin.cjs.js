"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var fetch=_interopDefault(require("fetch-everywhere")),Promise=_interopDefault(require("es6-promise")),Config=function(t){this.clientId=t.publicId,this.clientSecret=t.secretKey,this.host="api-dev.moltin.com",this.port="443",this.protocol="http",this.version="v2",this.debug=!1,this.currency=t.currency,this.language=!1,this.timeout=6e4,this.contentType="application/json",this.auth={expires:3600,uri:"oauth/access_token"},this.methods=["GET","POST","PUT","DELETE"]},StorageFactory=function(){if("undefined"==typeof localStorage||null===localStorage){var t=require("node-localstorage").LocalStorage;this.localStorage=new t("./localStorage")}else this.localStorage=window.localStorage};StorageFactory.prototype.set=function(t,e){return this.localStorage.setItem(t,e)},StorageFactory.prototype.get=function(t){return this.localStorage.getItem(t)},StorageFactory.prototype.delete=function(t){return this.localStorage.removeItem(t)};var RequestFactory=function(t){this.config=t,this.storage=new StorageFactory};RequestFactory.prototype.authenticate=function(){var t=this.config,e=this.storage;if(t.clientId.length<=0)throw new Error("You must have a client id set");var n={grant_type:t.clientSecret?"client_credentials":"implicit",client_id:t.clientId};t.clientSecret&&(n.client_secret=t.clientSecret);var r=new Promise(function(e,r){fetch(t.protocol+"://"+t.host+"/"+t.auth.uri,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:Object.keys(n).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(n[t])}).join("&")}).then(function(t){if(200===t.status){var n=t.json();e(n)}}).then(null,function(t){return r(t)})});return r.then(function(t){e.set("mtoken",t.access_token),e.set("mexpires",t.expires)}),r},RequestFactory.prototype.send=function(t,e,n){var r=this,o=this.config,i=this.storage,s=new Promise(function(s,c){var a=function(){var r={Authorization:"Bearer: "+i.get("mtoken"),"Content-Type":o.contentType};o.currency&&(r["X-MOLTIN-CURRENCY"]=o.currency),"POST"!==e&&"PUT"!==e||(n='{"data":'+JSON.stringify(n)+"}"),fetch(o.protocol+"://"+o.host+"/"+o.version+"/"+t,{method:e.toUpperCase(),headers:r,body:n}).then(function(t){s(t.json())}).catch(function(t){return c(t)})};return!i.get("mtoken")||Date.now().toString()>=i.get("mexpires")?r.authenticate().then(a).catch(function(t){return c(t)}):void a()});return s};var Abstract=function(t){this.request=new RequestFactory(t),this.config=t};Abstract.prototype.Get=function(t,e){if("carts"===this.endpoint)return this.request.send(this.endpoint+"/"+this.cartId,"GET");if(e){var n=e.toString();return this.request.send(this.endpoint+"/"+t+"?include="+n,"GET")}return this.request.send(this.endpoint+"/"+t,"GET")},Abstract.prototype.List=function(t){if(t){var e=t.toString();return this.request.send(this.endpoint+"?include="+e,"GET")}return this.request.send(""+this.endpoint,"GET")};var ProductsEndpoint=function(t){function e(e){t.call(this,e),this.endpoint="products"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Abstract),CurrenciesEndpoint=function(t){function e(e){t.call(this,e),this.endpoint="currencies",this.storage=new StorageFactory}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.Set=function(t){var e=this.storage,n=this.config;e.set("mcurrency",t),n.currency=t;var r=new Promise(function(t,n){var r=e.get("mcurrency");try{t(r)}catch(t){n(new Error(t))}});return r},e.prototype.Active=function(){var t=this.storage,e=new Promise(function(e,n){var r=t.get("mcurrency");try{e(r)}catch(t){n(new Error(t))}});return e},e}(Abstract),BrandsEndpoint=function(t){function e(e){t.call(this,e),this.endpoint="brands"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Abstract),CartEndpoint=function(t){function e(e){t.call(this,e),this.endpoint="carts",this.storage=new StorageFactory,this.cartId=this.identifier()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.identifier=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=!1);var n=this.storage;return t||e||null===n.get("mcart")?(e||(e="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx".replace(/[x]/g,function(){return(16*Math.random()|0).toString(16)})),n.set("mcart",e),e):n.get("mcart")},e.prototype.Contents=function(){return this.request.send(this.endpoint+"/"+this.cartId+"/items","GET")},e.prototype.Insert=function(t,e){var n={id:t,quantity:parseInt(e)||1};return this.request.send(this.endpoint+"/"+this.cartId+"/items","POST",n)},e.prototype.Remove=function(t){return this.request.send(this.endpoint+"/"+this.cartId+"/items/"+t,"DELETE")},e.prototype.Quantity=function(t,e){var n={quantity:parseInt(e)};return this.request.send(this.endpoint+"/"+this.cartId+"/items/"+t,"PUT",n)},e.prototype.Complete=function(t){return this.request.send(this.endpoint+"/"+this.cartId+"/checkout","POST",t)},e.prototype.Delete=function(){return this.request.send(this.endpoint+"/"+this.cartId,"DELETE")},e}(Abstract),CategoriesEndpoint=function(t){function e(e){t.call(this,e),this.endpoint="categories"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.Tree=function(){return this.request.send(this.endpoint+"/tree","GET")},e}(Abstract),CollectionsEndpoint=function(t){function e(e){t.call(this,e),this.endpoint="collections"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Abstract),OrdersEndpoint=function(t){function e(e){t.call(this,e),this.endpoint="orders"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.Payment=function(t,e){return this.request.send(this.endpoint+"/"+t+"/payments","POST",e)},e}(Abstract),Moltin=function(t){this.config=t,this.request=new RequestFactory(t),this.storage=new StorageFactory,this.Products=new ProductsEndpoint(t),this.Currencies=new CurrenciesEndpoint(t),this.Brands=new BrandsEndpoint(t),this.Cart=new CartEndpoint(t),this.Categories=new CategoriesEndpoint(t),this.Collections=new CollectionsEndpoint(t),this.Orders=new OrdersEndpoint(t)};Moltin.prototype.Authenticate=function(){return this.request.authenticate()};var gateway=function(t){return new Moltin(new Config(t))};exports.gateway=gateway;
//# sourceMappingURL=moltin.cjs.js.map
